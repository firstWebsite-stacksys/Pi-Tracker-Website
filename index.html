import React, { useState, useEffect, useRef } from 'react';
import { Trophy, RotateCcw, ChevronRight } from 'lucide-react';

const PI_DIGITS = "3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989";

export default function PiMemoryGame() {
  const [startDigit, setStartDigit] = useState(0);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [userInput, setUserInput] = useState('');
  const [score, setScore] = useState(0);
  const [gameOver, setGameOver] = useState(false);
  const [showStartMenu, setShowStartMenu] = useState(true);
  const [startInput, setStartInput] = useState('0');
  const inputRef = useRef(null);
  const displayRef = useRef(null);

  useEffect(() => {
    if (!showStartMenu && !gameOver && inputRef.current) {
      inputRef.current.focus();
    }
  }, [showStartMenu, gameOver]);

  useEffect(() => {
    if (displayRef.current) {
      const container = displayRef.current.querySelector('.overflow-x-auto');
      if (container) {
        container.scrollLeft = container.scrollWidth;
      }
    }
  }, [currentIndex]);

  const startGame = () => {
    const digit = parseInt(startInput) || 0;
    if (digit >= 0 && digit < PI_DIGITS.length) {
      setStartDigit(digit);
      setCurrentIndex(digit);
      setScore(0);
      setGameOver(false);
      setShowStartMenu(false);
      setUserInput('');
    }
  };

  const handleInput = (e) => {
    const value = e.target.value;
    setUserInput(value);

    const expectedDigit = PI_DIGITS[currentIndex];
    
    if (value === expectedDigit || (expectedDigit === '.' && value === '.')) {
      setScore(score + 1);
      setCurrentIndex(currentIndex + 1);
      setUserInput('');
      
      if (currentIndex >= PI_DIGITS.length - 1) {
        setGameOver(true);
      }
    } else if (value !== '') {
      setGameOver(true);
    }
  };

  const reset = () => {
    setShowStartMenu(true);
    setStartInput('0');
  };

  const getDisplayRange = () => {
    const start = Math.max(0, currentIndex - 100);
    return {
      before: PI_DIGITS.slice(start, currentIndex),
      current: PI_DIGITS[currentIndex]
    };
  };

  const display = getDisplayRange();

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 to-gray-800 flex items-center justify-center p-4">
      {showStartMenu ? (
        <div className="bg-gray-800 rounded-2xl shadow-2xl p-8 max-w-md w-full border border-gray-700">
          <div className="text-center mb-8">
            <h1 className="text-4xl font-bold text-indigo-400 mb-2">Ï€ Memory Game</h1>
            <p className="text-gray-400">Practice memorizing pi from any digit</p>
          </div>

          <div className="space-y-6">
            <div>
              <label className="block text-sm font-medium text-gray-300 mb-2">
                Start from digit position:
              </label>
              <input
                type="number"
                min="0"
                max={PI_DIGITS.length - 1}
                value={startInput}
                onChange={(e) => setStartInput(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && startGame()}
                className="w-full px-4 py-3 bg-gray-700 border-2 border-gray-600 text-white rounded-lg focus:border-indigo-500 focus:outline-none text-lg"
                placeholder="0"
              />
              <p className="mt-2 text-sm text-gray-400">
                Position 0 = "3", Position 1 = ".", Position 2 = "1", etc.
              </p>
            </div>

            <button
              onClick={startGame}
              className="w-full bg-indigo-600 text-white py-4 rounded-lg font-semibold text-lg hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2"
            >
              Start Game <ChevronRight size={20} />
            </button>

            <div className="bg-gray-700 rounded-lg p-4 text-sm text-gray-300 border border-gray-600">
              <p className="font-medium mb-1">Preview from position {startInput}:</p>
              <p className="font-mono text-indigo-400">
                {PI_DIGITS.slice(parseInt(startInput) || 0, (parseInt(startInput) || 0) + 20)}...
              </p>
            </div>
          </div>
        </div>
      ) : (
        <div className="bg-gray-800 rounded-2xl shadow-2xl p-8 max-w-3xl w-full border border-gray-700">
          <div className="flex justify-between items-center mb-6">
            <div className="flex items-center gap-2 text-indigo-400">
              <Trophy size={24} />
              <span className="text-2xl font-bold">{score}</span>
              <span className="text-gray-400 text-sm">digits (from pos {startDigit})</span>
            </div>
            <button
              onClick={reset}
              className="flex items-center gap-2 px-4 py-2 bg-gray-700 text-gray-200 rounded-lg hover:bg-gray-600 transition-colors"
            >
              <RotateCcw size={20} />
              New Game
            </button>
          </div>

          {!gameOver ? (
            <div className="space-y-6">
              <div 
                ref={displayRef}
                className="relative bg-gray-700 rounded-lg p-6 font-mono text-2xl border border-gray-600 overflow-hidden"
                style={{ 
                  maxHeight: '100px',
                  position: 'relative'
                }}
              >
                <div 
                  className="absolute left-0 top-0 bottom-0 w-20 pointer-events-none z-10"
                  style={{
                    background: 'linear-gradient(to right, rgb(55, 65, 81), transparent)'
                  }}
                />
                <div className="overflow-x-auto whitespace-nowrap" style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}>
                  <style>{`
                    .overflow-x-auto::-webkit-scrollbar {
                      display: none;
                    }
                  `}</style>
                  <span className="text-indigo-400 font-semibold">{display.before}</span>
                  <span className="text-indigo-400 font-bold animate-pulse">_</span>
                </div>
              </div>

              <div className="text-center">
                <p className="text-gray-300 mb-3">Type the next digit:</p>
                <input
                  ref={inputRef}
                  type="text"
                  value={userInput}
                  onChange={handleInput}
                  className="w-32 text-4xl text-center bg-gray-700 border-4 border-indigo-500 text-white rounded-lg focus:border-indigo-400 focus:outline-none py-3 font-mono font-bold"
                  maxLength="1"
                  autoComplete="off"
                />
              </div>

              <div className="text-center text-sm text-gray-400">
                Position: {currentIndex} / {PI_DIGITS.length - 1}
              </div>
            </div>
          ) : (
            <div className="text-center space-y-6">
              <div className="text-6xl">ðŸ˜¢</div>
              <h2 className="text-3xl font-bold text-gray-100">Game Over!</h2>
              <p className="text-xl text-gray-300">
                You remembered <span className="font-bold text-indigo-400">{score}</span> digits
              </p>
              <p className="text-gray-400">
                Started from position {startDigit}, reached position {currentIndex}
              </p>
              <div className="bg-gray-700 border-2 border-gray-600 rounded-lg p-4 font-mono text-lg overflow-x-auto">
                <p className="text-gray-300 mb-2">Your progress:</p>
                <p className="text-indigo-400 font-semibold text-xl mb-1">
                  {PI_DIGITS.slice(startDigit, currentIndex)}
                </p>
              </div>
              <div className="bg-red-900 bg-opacity-30 border-2 border-red-700 rounded-lg p-4 font-mono text-lg">
                <p className="text-gray-300 mb-2">The next 10 digits were:</p>
                <p className="text-red-400 font-bold text-2xl">
                  {PI_DIGITS.slice(currentIndex, currentIndex + 10)}
                </p>
              </div>
              <div className="flex gap-4 justify-center">
                <button
                  onClick={() => {
                    setCurrentIndex(startDigit);
                    setScore(0);
                    setGameOver(false);
                    setUserInput('');
                  }}
                  className="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors"
                >
                  Retry from {startDigit}
                </button>
                <button
                  onClick={reset}
                  className="px-6 py-3 bg-gray-700 text-gray-200 rounded-lg font-semibold hover:bg-gray-600 transition-colors"
                >
                  Choose New Start
                </button>
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
